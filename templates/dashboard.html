<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbound Carrier Analytics | Real-Time Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script>
        // Fallback Chart.js loading
        if (typeof Chart === 'undefined') {
            console.log('Loading Chart.js fallback...');
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js';
            script.onload = function() {
                console.log('Chart.js loaded from fallback CDN');
                // Reinitialize charts if they failed to load
                if (typeof initializeCharts === 'function') {
                    initializeCharts();
                }
            };
            script.onerror = function() {
                console.error('Failed to load Chart.js from both CDNs');
            };
            document.head.appendChild(script);
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            color: #2c3e50;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Header */
        .dashboard-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        
        .header-left p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .live-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        
        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* KPI Cards Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        }
        
        .kpi-card.success::before { background: linear-gradient(90deg, #10b981, #34d399); }
        .kpi-card.warning::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .kpi-card.danger::before { background: linear-gradient(90deg, #ef4444, #f87171); }
        
        .kpi-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .kpi-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }
        
        .kpi-change {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .kpi-change.positive { color: #10b981; }
        .kpi-change.negative { color: #ef4444; }
        
        /* Charts Section */
        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .charts-row-three {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            height: 400px;
            position: relative;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            text-align: left;
            padding: 0.75rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .table td {
            padding: 0.75rem;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .table tr:hover {
            background: #f8fafc;
        }
        
        /* Status Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }
        
        .badge.accepted { background: #d1fae5; color: #065f46; }
        .badge.rejected { background: #f3f4f6; color: #f20909; }
        .badge.failed { background: #f3f4f6; color: #6b7280; }
        .badge.no-agreement { background: #f3f4f6; color: #6b7280; }
        .badge.incomplete { background: #f3f4f6; color: #6b7280; }
        
        /* Real-time Updates */
        .update-notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #1e293b;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
            .charts-row-three {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }
        
        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tooltip styles */
        .info-icon {
            position: relative;
            display: inline-block;
        }
        
        .info-icon .tooltip {
            visibility: hidden;
            width: 300px;
            background-color: #1e293b;
            color: white;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-line;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .info-icon .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1e293b transparent transparent transparent;
        }
        
        .info-icon:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-left">
                <h1>📊 Inbound Carrier Analytics</h1>
                <p>Real-Time Performance Monitoring</p>
            </div>
            <div class="header-right">
                <div class="live-indicator">
                    <span class="live-dot"></span>
                    <span>Live</span>
                </div>
                <select id="timeRange" onchange="updateDashboard()">
                    <option value="today">Today</option>
                    <option value="7" selected>Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last Quarter</option>
                </select>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Primary KPIs -->
        <div class="kpi-grid" id="kpiGrid">
            <div class="kpi-card success">
                <div class="kpi-label">Call-to-Booking Rate</div>
                <div class="kpi-value" id="bookingRate">--</div>
                <div class="kpi-change positive">✓ <span id="successfulCallsCount">--</span></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Total Calls</div>
                <div class="kpi-value" id="totalCalls">--</div>
                <div class="kpi-change" id="callsTrend">--</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Avg Negotiation Rounds</div>
                <div class="kpi-value" id="avgNegotiationRounds">--</div>
                <div class="kpi-change" id="negotiationTrend">--</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">MC Verification Rate</div>
                <div class="kpi-value" id="verificationRate">--</div>
                <div class="kpi-change positive">✓ <span id="verificationCount">--</span></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Total Revenue Collected</div>
                <div class="kpi-value" id="revenueImpact">--</div>
                <div class="kpi-change positive" id="revenueTrend">--</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="charts-row-three">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Sentiment Distribution</h3>
                    <div class="info-icon">
                        <span style="cursor: help; color: #6b7280; font-size: 1.2rem;">ℹ️</span>
                        <div class="tooltip">Sentiment Classifications:
• Positive: Carrier shows enthusiasm, agrees readily, or expresses satisfaction
• Neutral: Carrier maintains professional tone without strong positive or negative emotions
• Negative: Carrier shows frustration, disagreement, or dissatisfaction</div>
                    </div>
                </div>
                <canvas id="sentimentChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Outcome Distribution</h3>
                    <div class="info-icon">
                        <span style="cursor: help; color: #6b7280; font-size: 1.2rem;">ℹ️</span>
                        <div class="tooltip">Outcome Classifications:
• Accepted: Carrier agrees to the load and booking is confirmed
• Rejected: Carrier declines the load offer or negotiation ends without agreement
• Failed: Technical issues or system errors prevent completion
• Incomplete: Call was terminated before reaching a conclusion</div>
                    </div>
                </div>
                <canvas id="outcomeChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Equipment Demand</h3>
                </div>
                <canvas id="equipmentChart"></canvas>
            </div>
        </div>

        <!-- Recent Calls Table -->
        <div class="table-container">
            <div class="chart-header">
                <h3 class="chart-title">Recent Call Activity</h3>
                <button onclick="exportData()" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">Export CSV</button>
            </div>
            <table class="table" id="recentCallsTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Carrier</th>
                        <th>MC#</th>
                        <th>Equipment</th>
                        <th>Route</th>
                        <th>Outcome</th>
                        <th>Agreed Rate</th>
                        <th>Sentiment</th>
                    </tr>
                </thead>
                <tbody id="callsTableBody">
                    <tr><td colspan="8" style="text-align: center; padding: 2rem;">Loading...</td></tr>
                </tbody>
            </table>
        </div>

    </div>

    <!-- Update Notification -->
    <div class="update-notification" id="updateNotification">
        New call data received!
    </div>

    <script>
        // Global variables
        let dashboardData = {};
        let charts = {};
        let updateInterval;
        let previousCallCount = 0;
        
        // Helper function to adjust time by subtracting 7 hours
        function adjustTime(dateString) {
            const date = new Date(dateString);
            date.setHours(date.getHours() - 7);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            startAutoRefresh();
        });
        
        // Initialize and fetch data
        async function initializeDashboard() {
            await fetchDashboardData();
            // Initialize the call count for tracking new calls
            previousCallCount = dashboardData.dashboard?.overview?.total_calls || 0;
            initializeCharts();
            updateKPIs();
            updateTables();
        }
        
        // Fetch dashboard data
        async function fetchDashboardData() {
            try {
                const timeRange = document.getElementById('timeRange').value;
                const days = timeRange === 'today' ? 1 : parseInt(timeRange);
                
                // Show loading state
                showLoadingState();
                
                // For the assessment, we'll use the internal endpoint
                const response = await fetch(`/api/dashboard-data?days=${days}`);
                const result = await response.json();
                
                if (result.ok) {
                    dashboardData = result.data;
                    console.log('Dashboard data loaded:', dashboardData);
                    console.log('Dashboard structure:', {
                        hasDashboard: !!dashboardData.dashboard,
                        hasOverview: !!dashboardData.dashboard?.overview,
                        hasPerformance: !!dashboardData.dashboard?.performance,
                        hasEnhanced: !!dashboardData.enhanced_metrics,
                        hasRecentCalls: !!dashboardData.recent_calls
                    });
                }
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                // Show error state instead of mock data
                dashboardData = {};
                showErrorState(error.message);
            }
        }
        
        // Update KPIs
        function updateKPIs() {
            const metrics = dashboardData.dashboard || {};
            const overview = metrics.overview || {};
            const performance = metrics.performance || {};
            const operational = metrics.operational || {};
            const enhanced = dashboardData.enhanced_metrics || {};
            
            // Update KPI values with fallbacks
            document.getElementById('bookingRate').textContent = 
                overview.load_booking_rate ? `${overview.load_booking_rate.toFixed(1)}%` : 
                enhanced.first_call_resolution_rate ? `${enhanced.first_call_resolution_rate.toFixed(1)}%` : '0%';
            
            document.getElementById('totalCalls').textContent = 
                overview.total_calls || '0';
            
            document.getElementById('avgNegotiationRounds').textContent = 
                performance.avg_negotiation_rounds ? `${performance.avg_negotiation_rounds.toFixed(1)}` : '0';
            
            document.getElementById('verificationRate').textContent = 
                overview.verification_rate ? `${overview.verification_rate.toFixed(1)}%` : '0%';
            
            
            document.getElementById('revenueImpact').textContent = 
                overview.total_revenue ? `$${overview.total_revenue.toFixed(0)}` : '$0';
            
            // Update secondary metrics
            document.getElementById('verificationCount').textContent = 
                `${overview.verified_calls || 0} verified`;
            
            document.getElementById('successfulCallsCount').textContent = 
                `${overview.successful_calls || 0} successful`;
        }
        
        // Initialize Charts
        function initializeCharts() {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded. Charts will not be displayed.');
                return;
            }
            
            const metrics = dashboardData.dashboard || {};
            const trends = metrics.trends || {};
            const performance = metrics.performance || {};
            
            try {
                // Sentiment Distribution Chart
                const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
                const sentimentData = performance.sentiment_breakdown || {};
                charts.sentiment = new Chart(sentimentCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(sentimentData),
                        datasets: [{
                            data: Object.values(sentimentData),
                            backgroundColor: Object.keys(sentimentData).map(sentiment => {
                                switch(sentiment) {
                                    case 'positive': return '#10b981';
                                    case 'neutral': return '#fbbf24';
                                    case 'negative': return '#ef4444';
                                    default: return '#6b7280';
                                }
                            })
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 1.5,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            
            // Outcome Chart
            const outcomeCtx = document.getElementById('outcomeChart').getContext('2d');
            const outcomeData = performance.outcome_breakdown || {};
            charts.outcome = new Chart(outcomeCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(outcomeData),
                    datasets: [{
                        data: Object.values(outcomeData),
                        backgroundColor: Object.keys(outcomeData).map(outcome => {
                            switch(outcome) {
                                case 'accepted': return '#10b981'; // Green
                                case 'failed': return '#ef4444'; // Red
                                case 'rejected': return '#f59e0b'; // Orange
                                case 'incomplete': return '#8b5cf6'; // Purple
                                default: return '#6b7280'; // Gray fallback
                            }
                        })
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
            
            // Equipment Chart
            const equipmentCtx = document.getElementById('equipmentChart').getContext('2d');
            const enhanced = dashboardData.enhanced_metrics || {};
            const equipmentData = enhanced.equipment_match_rates || {};
            
            // Prepare equipment chart data
            const equipmentLabels = Object.keys(equipmentData);
            const equipmentTotals = Object.values(equipmentData).map(d => d.total || 0);
            const equipmentSuccesses = Object.values(equipmentData).map(d => d.successful || 0);
            
            charts.equipment = new Chart(equipmentCtx, {
                type: 'bar',
                data: {
                    labels: equipmentLabels,
                    datasets: [{
                        label: 'Total Requests',
                        data: equipmentTotals,
                        backgroundColor: '#e5e7eb'
                    }, {
                        label: 'Successful',
                        data: equipmentSuccesses,
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    indexAxis: 'y',
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            } catch (error) {
                console.error('Error initializing charts:', error);
            }
        }
        
        // Update Tables
        function updateTables() {
            const recentCalls = dashboardData.recent_calls || [];
            
            // Update Recent Calls Table
            const callsBody = document.getElementById('callsTableBody');
            if (recentCalls.length > 0) {
                callsBody.innerHTML = recentCalls.slice(0, 10).map(call => `
                    <tr>
                        <td>${adjustTime(call.created_at)}</td>
                        <td>${call.carrier_name || 'Unknown'}</td>
                        <td>${call.carrier_mc || '--'}</td>
                        <td>${call.equipment_type || '--'}</td>
                        <td>${call.origin_preference || '--'} → ${call.destination_preference || '--'}</td>
                        <td><span class="badge ${(call.outcome === 'no_agreement' || call.outcome === 'no-agreement') ? 'rejected' : (call.outcome || 'rejected')}">${(call.outcome === 'no_agreement' || call.outcome === 'no-agreement') ? 'rejected' : (call.outcome || 'rejected')}</span></td>
                        <td>${call.outcome === 'accepted' ? (call.final_rate ? `$${call.final_rate}` : '$0') : '$0'}</td>
                        <td><span class="badge ${call.sentiment}">${call.sentiment || 'neutral'}</span></td>
                    </tr>
                `).join('');
            } else {
                callsBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No recent calls</td></tr>';
            }
        }
        
        // Auto-refresh functionality
        function startAutoRefresh() {
            // Refresh every 30 seconds
            updateInterval = setInterval(async () => {
                const oldCallCount = previousCallCount;
                await fetchDashboardData();
                
                // Check if there are new calls
                const currentCallCount = dashboardData.dashboard?.overview?.total_calls || 0;
                if (currentCallCount > oldCallCount && oldCallCount > 0) {
                    showUpdateNotification(); // Only show notification if there are actually new calls
                }
                previousCallCount = currentCallCount;
                
                updateKPIs();
                updateTables();
                updateCharts();
            }, 30000);
        }
        
        // Update charts with new data
        function updateCharts() {
            // Update chart data without reinitializing
            if (charts.sentiment && typeof Chart !== 'undefined') {
                try {
                    const performance = dashboardData.dashboard?.performance || {};
                    const sentimentData = performance.sentiment_breakdown || {};
                    charts.sentiment.data.labels = Object.keys(sentimentData);
                    charts.sentiment.data.datasets[0].data = Object.values(sentimentData);
                    charts.sentiment.data.datasets[0].backgroundColor = Object.keys(sentimentData).map(sentiment => {
                        switch(sentiment) {
                            case 'positive': return '#10b981';
                            case 'neutral': return '#fbbf24';
                            case 'negative': return '#ef4444';
                            default: return '#6b7280';
                        }
                    });
                    charts.sentiment.update();
                } catch (error) {
                    console.error('Error updating charts:', error);
                }
            }
            
            // Update outcome chart
            if (charts.outcome && typeof Chart !== 'undefined') {
                try {
                    const performance = dashboardData.dashboard?.performance || {};
                    const outcomeData = performance.outcome_breakdown || {};
                    charts.outcome.data.labels = Object.keys(outcomeData);
                    charts.outcome.data.datasets[0].data = Object.values(outcomeData);
                    charts.outcome.data.datasets[0].backgroundColor = Object.keys(outcomeData).map(outcome => {
                        switch(outcome) {
                            case 'accepted': return '#10b981'; // Green
                            case 'failed': return '#ef4444'; // Red
                            case 'rejected': return '#f59e0b'; // Orange
                            case 'incomplete': return '#8b5cf6'; // Purple
                            default: return '#6b7280'; // Gray fallback
                        }
                    });
                    charts.outcome.update();
                } catch (error) {
                    console.error('Error updating outcome chart:', error);
                }
            }
        }
        
        // Show update notification
        function showUpdateNotification() {
            const notification = document.getElementById('updateNotification');
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Show loading state while fetching data
        function showLoadingState() {
            // Update KPI cards to show loading state
            document.getElementById('bookingRate').textContent = '...';
            document.getElementById('totalCalls').textContent = '...';
            document.getElementById('avgNegotiationRounds').textContent = '...';
            document.getElementById('verificationRate').textContent = '...';
            document.getElementById('revenueImpact').textContent = '...';
            document.getElementById('successfulCallsCount').textContent = '...';
            
            // Show loading in tables
            document.getElementById('callsTableBody').innerHTML = 
                '<tr><td colspan="8" style="text-align: center; padding: 2rem;">Loading...</td></tr>';
        }
        
        // Show error state when data fails to load
        function showErrorState(errorMessage) {
            // Update KPI cards to show error state
            document.getElementById('bookingRate').textContent = '--';
            document.getElementById('totalCalls').textContent = '--';
            document.getElementById('avgNegotiationRounds').textContent = '--';
            document.getElementById('verificationRate').textContent = '--';
            document.getElementById('revenueImpact').textContent = '--';
            document.getElementById('successfulCallsCount').textContent = '--';
            
            // Show error in tables
            document.getElementById('callsTableBody').innerHTML = 
                '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #ef4444;">Error loading data: ' + errorMessage + '</td></tr>';
            
            console.error('Dashboard error state:', errorMessage);
        }
        
        // Update dashboard when time range changes
        async function updateDashboard() {
            await fetchDashboardData();
            updateKPIs();
            updateTables();
            updateCharts();
            // Don't show notification for manual time range changes
        }
        
        // Export data as CSV
        function exportData() {
            const recentCalls = dashboardData.recent_calls || [];
            let csv = 'Time,Carrier,MC#,Equipment,Route,Outcome,Agreed Rate,Sentiment\n';
            
            recentCalls.forEach(call => {
                csv += `${adjustTime(call.created_at)},`;
                csv += `${call.carrier_name || 'Unknown'},`;
                csv += `${call.carrier_mc || ''},`;
                csv += `${call.equipment_type || ''},`;
                csv += `${call.origin_preference || ''} to ${call.destination_preference || ''},`;
                csv += `${(call.outcome === 'no_agreement' || call.outcome === 'no-agreement') ? 'rejected' : (call.outcome || 'rejected')},`;
                csv += `${call.outcome === 'accepted' ? (call.final_rate ? `$${call.final_rate}` : '$0') : '$0'},`;
                csv += `${call.sentiment || 'neutral'}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `carrier_calls_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
    </script>
</body>
</html>